---
output:
  pdf_document:
    fig_caption: yes
    template: sample-acmsmall.tex
    keep_tex: yes
    latex_engine: xelatex
    number_sections: yes
bibliography: GenderBiblio.bib
---

 
```{r TRACER_setup, echo=FALSE, include=FALSE, warning=FALSE, cache=FALSE}
#   citation_package: natbib

# pdf_document:

# library(tinytex)
# install_version("rmarkdown",version=1.8)

# bookdown::pdf_book:
# csl: apa.csl
# csl: acmart.csl
# Sys.setenv(PATH=paste(Sys.getenv("PATH"),"C:\\Program Files\\MiKTeX 2.9\\miktex\\bin\\x64\\",sep=";"))

knitr::opts_chunk$set(cache=TRUE, echo = FALSE, warning = FALSE, message = FALSE, dpi=200)
knitr::opts_chunk$set(fig.width = 6)
library(knitr)
library(grid)
library(gridExtra)
library(reshape2)

options(hline.after=c(-1))
options(xtable.comment=FALSE)
#!h places tables where you put them rather than floating them about
options(xtable.table.placement="H")
options(xtable.include.rownames=FALSE)
options(xtable.tabular.environment="longtable")
options(xtable.keep.trailing.zeros=TRUE)
options(xtable.caption.placement = "top")

# options(xtable.sanitize.text.function = identity)
 
basefolder <- "C:\\Users\\Peter\\Desktop\\export\\Codebase\\NPDbase"
codefolder <- paste0(basefolder, "/code/")
source(paste0(codefolder,'Tools.R'))
source(paste0(codefolder,'Collation.R'))
source(paste0(codefolder,'Graphs.R'))
source(paste0(codefolder,'Loading.R'))
source(paste0(codefolder,'Tables.R'))
source(paste0(codefolder,'Statistics.R'))
source(paste0(codefolder,'DfEAnalysis.R'))
source(paste0(codefolder,'PrettyPrinting.R'))
```
```{r TRACER_Load_Data_Global, echo=FALSE, include=FALSE}
map_width <- 6.5#'100%'
map_height <- 8#'100%'
graph_width <- "100%"

axis_size <- 9

london_map_height <- 3
london_map_width <- 4
 
datafolder <- paste0(basefolder, "/data/")
cleanfolder <- paste0(basefolder, "/data/cleaned/")
schools <- loadSchools(dir=basefolder)
postcodes <- loadPostcodes(dir=basefolder)
# LAmap <- loadMap("LEA", dir=basefolder)
# Regionmap <- loadMap("Region", dir=basefolder)
# LEAs <- getLocalEducationAuthorities(dir=basefolder)
 
subject_name <- "Computer Science"
subject_code_char <- "2610"
subject_code <- quo(X2610)
level <- "310"
year <- 16
year_range <- c(16)
comparison_subjects <- c(quo(X2610),quo(X3670),quo(X2610))
names(comparison_subjects) <- c(subject_name,"Physics", "ICT")
```
```{r TRACER_Load_Data_GCSE_Years, echo=FALSE, include=FALSE}

#load all Students, Results and Spreads for GCSE/A-level into global variables
for(yr in year_range){
  # 310 = GCSE; 111 = A-Level; 121 = AS-Level
  initialiseDataFrames("KS4", "GCSE", as.character(yr), cleanfolder)
}
 
 
```
 
```{r Gender_combine_years, echo=FALSE, include=FALSE}
Spread_GCSE_All <- Spread_GCSE_16
Students_GCSE_All <- Students_GCSE_16
Results_GCSE_All <- Results_GCSE_16

```
 
```{r Table_uplift_by_school_size}
 
 
differential_by_school <- function(sub, df){
  #df <- Spread_GCSE_All
  #sub <- "X2650"
  subject <- sub
  sub <- sym(sub)
 
  # filter out the subjtec grades to get average
  results_with_avg <- df[,names(df) != sub]
  Avg_grades <- results_with_avg %>%
    select(grep("X", names(.))) %>%
    rowMeans(na.rm=TRUE)
 
  # combine average grades to each student record
  results <- df
  results$Avg_grades <- Avg_grades
  results <- results %>% filter(!is.nan(Avg_grades))
 
  # do this for each school by gender
  # Focus_results <- results %>% filter(!is.na(!!sub), schType != "Boys") %>% select(URN,GENDER,!!sub, Avg_grades)
  Focus_results <- results %>% filter(!is.na(!!sub)) %>% select(URN, schGender, GENDER, (!!sub), Avg_grades)
 
  subject_gender_girl_per <- Focus_results %>% group_by(URN) %>% mutate(diff = (!!sub) - Avg_grades) %>%
    group_by(URN, GENDER) %>% summarise(diff = mean(diff),
                                        avg = mean((!!sub)),
                                        n = n(),
                                        schGender = unique(schGender)) %>% ungroup()
 
  # vectorises the conversion to a school by school report on relative student results.
 
  subject_gender_girl_per <- subject_gender_girl_per %>%
    gather(variable, value, -c(URN, GENDER, schGender)) %>%
    unite(temp, GENDER, variable) %>%
    spread(temp, value, fill=0) %>%
    mutate(girl_per = ifelse(F_n == 0, 0,
                             ifelse(M_n == 0, 100,
                                    100*(F_n / (F_n + M_n))))) %>%
                  filter(!is.na(`schGender`))
 
  names(subject_gender_girl_per) <- c("urn", "School Gender", "girl_avg", "girls_diff", "girls", "boys_avg", "boys_diff", "boys", "girl_per")
 
  subject_gender_girl_per$Subject <- subject
 
  return(subject_gender_girl_per)
}
 
 
subject_gender_urn_per_cs <- differential_by_school("X2610", Spread_GCSE_All)
subject_gender_urn_per_ict <- differential_by_school("X2650", Spread_GCSE_All)
subject_gender_urn_per_physics <- differential_by_school("X2210", Spread_GCSE_All)
 
# TODO: use the data above to make graphs using impact of female group size.
 
```
 
```{r Graph_gender_group_size}
# check that this is still needed, and why it only fires for 138193
 
graph_data <- rbind(rbind(subject_gender_urn_per_cs %>% filter(`School Gender` != "Not applicable"),
       subject_gender_urn_per_ict %>% filter(`School Gender` != "Not applicable")),
        subject_gender_urn_per_physics %>% filter(`School Gender` != "Not applicable"))

# put data in a format for multi facet plotting
graph_data <- graph_data %>% gather(key, value, -urn, -`School Gender`, -Subject) %>%
  mutate(Gender = substr(key,1,1),
         key = ifelse(key %in% c("girls", "boys"),
                      "n",
                      gsub(".*_","",key))) %>%
  spread(key, value, fill = 0) %>%
  group_by(urn, Subject) %>%
  mutate(per = 100 * (n / sum(n)),
         total = sum(n)) %>%
  mutate(Gender = ifelse(Gender == "b", "Male",
                        ifelse(Gender == "g", "Female",NA))) %>%
  ungroup() %>%
  mutate(Subject = ifelse(Subject == "X2210", "Maths",
                        ifelse(Subject == "X2610", "CS",
                               ifelse(Subject == "X2650", "ICT",NA))))
 

##############
### GRAPHS ###
##############

  cur_graph_data <- graph_data %>%
    filter(per != 0, 
           Subject != "Maths") %>% 
    ungroup()
  


  graph_gender_n_perf <- ggplot(cur_graph_data %>% filter(Subject == "CS") %>% 
                           mutate(`School Gender` = ifelse(`School Gender` != "Mixed", 
                                                           "Single", as.character(`School Gender`))), 
                         aes(n, diff, colour=Gender)) + 
                    geom_point(alpha=0.1, 
                               aes(ifelse(n <6, 6, 2 * round(n/2)), diff),  
                               position = position_jitter(w = 0, h = 0.1)) +
                           geom_smooth(method="lm",
                                        se = TRUE,
                                       aes(as.numeric(n), diff, fill=Gender)) +
                    theme(axis.title=element_text(size=axis_size)) +
                    ylab("CS grade difference from average grade") +
                    xlab("number of CS students of given gender in a cohort") +
                    facet_grid(. ~ `School Gender`)
  
  graph_gender_per_perf <- ggplot(cur_graph_data %>% filter(Subject == "CS") %>% 
                                  filter(`School Gender` == "Mixed"), 
                               aes(per, diff, colour=Gender)) + 
                          geom_point(alpha=0.1, aes(2 * round(per/2), diff)) + 
                          geom_smooth(method="lm",
                                      se = TRUE,
                                      aes(as.numeric(per), diff, fill=Gender)) + 
                          theme(axis.title=element_text(size=axis_size)) +
                          ylab("CS grade difference from average grade") +
                          xlab("% of CS cohort of given gender") +
                          facet_grid(. ~ `School Gender`)
```
```{r model_gender_group_size}
#####################
### SUMMARY TABLE ###
#####################
cur_graph_data <- graph_data %>%
      filter(per != 0, 
             Subject == "CS") %>% 
      filter(Gender == "Female" & `School Gender` == "Girls" | 
               Gender == "Male" & `School Gender` == "Boys" | 
               `School Gender` == "Mixed" ) %>%
      ungroup() %>% 
    mutate(`School Gender` = 
             ifelse(`School Gender` != "Mixed", 
                         "Single", as.character(`School Gender`)))

  
output_summary <- function(smmy, focus){
  # smmy <- summary(lm(diff ~ n, cur_graph_data %>%
  #              filter(`School Gender` == "Mixed",
  #                     Gender == "Male")))
  # focus <- "n"
  
  intercept <- smmy$coefficients["(Intercept)","Estimate"]
  r.squared <-smmy$r.squared
  adj.r.squared <- smmy$adj.r.squared
  estimate <- smmy$coefficients[2,"Estimate"]
  p.value <- smmy$coefficients[2,"Pr(>|t|)"]

  p.star <-  convertStar(p=p.value)
  
  # 
  # if(p.value > 0.5){
  #   p.star <- "  "
  # }else if(p.value > 0.01){
  #   p.star <- "  *"
  # }else if(p.value > 0.001){
  #   p.star <- " **"
  # }else{
  #   p.star <- "***"
  # }

  stat_out <- read.csv(text = paste0("factor, Estimate, Std. Error, t value, Pr(>|t|), $R^2$
                       (Intercept),", smmy$coefficients["(Intercept)","Estimate"], "," , smmy$coefficients["(Intercept)","Std. Error"], "," , smmy$coefficients["(Intercept)","t value"], "," , smmy$coefficients["(Intercept)","Pr(>|t|)"],",
                        ",focus, ",", smmy$coefficients[focus,"Estimate"], "," , smmy$coefficients[focus,"Std. Error"], "," , smmy$coefficients[focus,"t value"], "," , smmy$coefficients[focus,"Pr(>|t|)"],",", r.squared))
           
  # message(stat_out)
              
 # "Est.", printper(estimate,3), p.star, " ", "R^2",  printper(r.squared,4))
  return(stat_out)
}

# lm for school types
modl_Mixed_n_male <- lm(diff ~ n, cur_graph_data %>% 
                         filter(`School Gender` == "Mixed", 
                                Gender == "Male"))
Mixed_n_male <- output_summary(summary(modl_Mixed_n_male), "n")

modl_Mixed_n_female <- lm(diff ~ n, cur_graph_data %>% 
             filter(`School Gender` == "Mixed", 
                    Gender == "Female"))
Mixed_n_female <- output_summary(summary(modl_Mixed_n_female), "n")

modl_Mixed_per_male  <- lm(diff ~ per, cur_graph_data %>% 
             filter(`School Gender` == "Mixed", 
                    Gender == "Male"))
Mixed_per_male <- output_summary(summary(modl_Mixed_per_male), "per")

modl_Mixed_per_female <- lm(diff ~ per, cur_graph_data %>% 
            filter(`School Gender` == "Mixed", 
                   Gender == "Female"))
Mixed_per_female <- output_summary(summary(modl_Mixed_per_female), "per")

modl_Single_n_male <- lm(diff ~ n, cur_graph_data %>% 
            filter(`School Gender` == "Single", 
                   Gender == "Male"))
Single_n_male <- output_summary(summary(modl_Single_n_male), "n")

modl_Single_n_female <- lm(diff ~ n, cur_graph_data %>% 
             filter(`School Gender` == "Single", 
                    Gender == "Female"))
Single_n_female <- output_summary(summary(modl_Single_n_female), "n")

school_type_diff <- rbind(Mixed_n_male, Mixed_n_female, Single_n_male, Single_n_female, Mixed_per_male, Mixed_per_female)
school_type_diff$Model <- c("Mixed Schools (Male)",
                            "Grade_difference ~ n",
                            "Mixed Schools (Female)",
                            "Grade_difference ~ n",
                            "Single Sex (Male)",
                            "Grade_difference ~ n",
                            "Single Sex - Female",
                            "Grade_difference ~ n",
                            "Mixed Schools (Male)",
                            "Grade_difference ~ %cohort",
                            "Mixed Schools (Female)",
                            "Grade_difference ~ %cohort")
# names(school_type_diff)
school_type_diff <- school_type_diff %>% select(Model, factor, Estimate, Std..Error, t.value,`Pr...t..`, X.R.2.)          
# names(school_type_diff) <- c("Model", "factor", "Estimate", "Std.Error", "t.value","Pr(>|t|)", "$R^2$")

addtorow_gen_size <- list()
addtorow_gen_size$pos <- list(0)
addtorow_gen_size$command <- c("Model $~$ Predictor & Factor & Estimate & Std.Error & t.value & Pr(>|t|) & $R^2$ \\\\\n")


out_school_type_gender_size <- xtable(school_type_diff,
                                caption=paste0("Difference between CS grade and average of other subjects predicted by group size. Models by gender and school type."),
                                align = c('l', 'p{1.6in}|','R{0.6in}','R{0.55in}','R{0.6in}',rep('R{0.5in}',2), 'R{0.3in}'),
                                digits=c(0,0,0,4,4,4,4,2))

out_modl_Mixed_n_male <- xtable(modl_Mixed_n_male)
out_modl_Mixed_n_female <- xtable(modl_Mixed_n_female)
out_modl_Mixed_per_male <- xtable(modl_Mixed_per_male)
out_modl_Mixed_per_female <- xtable(modl_Mixed_per_female)
out_modl_Single_n_male <- xtable(modl_Single_n_male)
out_modl_Single_n_female <- xtable(modl_Single_n_female)
  
 
```
 
```{r Table_relative_difficulty_of_subjects}
subjects <- names(Spread_GCSE_All %>% select(grep("X", names(.))))
 
# comparing effect of gender on results for all subjects
subject_gender_regression <- data.frame()
for (x in subjects){
  # x <- "X2610"
  message(x)
 
  # deselect the column we are focused on for making the Avg
  results_with_avg <- Spread_GCSE_All[,names(Spread_GCSE_All) != x]
  Avg_grades <- results_with_avg %>%
                      select(grep("X", names(.))) %>%
                      rowMeans(na.rm=TRUE)
  results <- Spread_GCSE_All
  results$Avg_grades <- Avg_grades
  results <- results %>% filter(!is.na(get(x)))
 
  message("n=", nrow(results))
  
  ##### NEW
  g <- "All"
  n_students <- nrow(results)
 
  if (nrow(results) > 60 & nrow(results %>% filter(!is.na(KS2Mat))) > 40){
    
    for(modl_name in c( " ~ GENDER + Avg_grades")){ #" ~ GENDER", " ~ Avg_grades:GENDER", " ~ GENDER + X2210", " ~ GENDER + KS2Mat"
      # modl_name <- " ~ GENDER + Avg_grades"
      temp <- summary(lm(paste(x, modl_name), data=results))

      if (!(x == "X2210" & modl_name == " ~ GENDER + X2210")){
        for(modl in rownames(temp$coefficients)){
            message(paste(modl_name, " ",modl, " ", x, g, n_students, 
                      temp$coefficients[modl,1],temp$coefficients[modl,2],temp$coefficients[modl,3], temp$coefficients[modl,4],temp$r.squared, temp$adj.r.squared, temp$fstatistic, temp$df))

            subject_gender_regression <- rbind(subject_gender_regression, 
                                              c(modl_name, modl, as.character(x), g, n_students, 
                                                temp$coefficients[modl,1],temp$coefficients[modl,2],
                                                temp$coefficients[modl,3], temp$coefficients[modl,4],
                                                temp$r.squared, temp$adj.r.squared, temp$fstatistic["value"], temp$fstatistic["numdf"]))

            names(subject_gender_regression) <- c("model","output","subject", "gender", 
                                                  "n", "est", "std_error", "z", "p", 
                                                  "r2", "adjr2", "f","df")
            
            subject_gender_regression <- subject_gender_regression %>%
              mutate(model= as.character(model),
                     output= as.character(output) ,
                     subject = as.character(subject),
                     gender = as.character(gender),
                     n = as.numeric(n),
                     est = as.numeric(est),
                     std_error = as.numeric(std_error),
                     z = as.numeric(z),
                     p = as.numeric(p),
                     r2 = as.numeric(r2),
                     adjr2 = as.numeric(adjr2),
                     f = as.numeric(f),
                     df = as.numeric(df))
            
        }
      }
    }
  }
}

# add average grade info to each subject
subject_avg_grades <- data.frame()
for(x in subjects){
  sub <- sym(x)
  message("average for ", x)
 
  avgGrades <- Spread_GCSE_All %>% select(GENDER, !!sub) %>%
    filter(!is.na(!!sub)) %>%
    group_by(GENDER) %>%
    summarise(M=mean(!!sub), SD=sd(!!sub),
              total=length(GENDER))
 
  subject_avg_grades <- rbind(subject_avg_grades,
                              c(x,
                                avgGrades %>% filter(GENDER == "F") %$% M,
                                avgGrades %>% filter(GENDER == "M") %$% M,
                                avgGrades %>% filter(GENDER == "F") %$% SD,
                                avgGrades %>% filter(GENDER == "M") %$% SD,
                                avgGrades %>% filter(GENDER == "M") %$% total,
                                avgGrades %>% filter(GENDER == "F") %$% total))
  names(subject_avg_grades) <- c("subject", "F_Mean","M_Mean", "F_SD", "M_SD", "F_n", "M_n")
  subject_avg_grades <- subject_avg_grades %>% mutate(subject = as.character(subject),
                                                      F_Mean = as.character(F_Mean),
                                                      M_Mean = as.character(M_Mean),
                                                      F_SD = as.character(F_SD),
                                                      M_SD = as.character(M_SD),
                                                      F_n = as.character(F_n),
                                                      M_n = as.character(M_n))
  # message(tail(subject_avg_grades,1))
 
}
 
# add the names to the subjects
Disccodes <-loadDiscMappings(basefolder)
Disccodes$MAPPING <- paste0("X",Disccodes$MAPPING)
subject_gender_regression <- left_join(subject_gender_regression, Disccodes, by=c("subject"="MAPPING")) %>% rename(`subject name` = MAPPING_DESCRIPTION)
subject_gender_regression <- left_join(subject_gender_regression, subject_avg_grades)
```
```{r Graph_significance_of_gender, cache=FALSE}
# save the graphs for each of the regression analyses

# for (c in unique(subject_gender_regression$model)){
  
  c <- " ~ GENDER + Avg_grades"
  data <- subject_gender_regression %>% filter(model == c,
                                               n > 40000,
                                               output == "GENDERM") %>% arrange(est)

  data$`subject name` <- as.vector(data$`subject name`)
  data$`subject name` <- factor(data$`subject name`, data$`subject name`)

  graph_gender <- ggplot(data,
         aes(x=`subject name`, y=est, colour=ifelse(p < 0.05, "Significant", "Not Significant"))) +
    geom_point(aes(  size = n)) + #,  size = n)
    coord_flip() +
    theme(axis.title=element_text(size=axis_size)) +
    labs(colour = "",
          shape = "",
          xlab="Estimate")
  
  assign("graph_significance_Gender_AvgGrade", graph_gender)
  
  # print(data)
  
  # assign(paste0("graph_significance_",c), graph_gender)
  # 
  # ggsave(file=paste0(basefolder,"/outputs/", c, ".svg"), plot= graph_gender, width=18, height = 18)
  # assign(paste0("graph_",x),graph_gender)
  # ggsave(file=paste0(basefolder,"/outputs/", c, ".png"), plot= graph_gender, width=18, height = 18)
# }
 
```

```{r Table_Gender_Stuff, echo=FALSE}

######### Comparison between male and female groups for effect of FSM
results <- cbind(Spread_GCSE_All %>% select(PupilMatchingRefAnonymous, URN, GENDER, EthMin, EthMaj, EVERFSM_6, IDACIScore), 
                 Spread_GCSE_All %>% select(grep("X", names(Spread_GCSE_All))) %>%
                   mutate_all(., ~(ifelse(is.na(.), as.numeric(0), as.numeric(1))))) %>%
                   filter(!is.na(EthMaj), !is.na(EVERFSM_6), !is.na(IDACIScore))

## automated of the above
uptake_gender_regression <- data.frame()

# set levels for ethnicity to have white as base case
ethfacts <- results %>% group_by(EthMaj) %>% summarise(n=n()) %>% arrange(desc(n)) %$% EthMaj
results$EthMaj <- factor(results$EthMaj, levels=ethfacts)



for (x in names(Spread_GCSE_All)[grep("X", names(Spread_GCSE_All))]){
  # x <- "X2610"
  # g <- "M"
  message(x)
  name <- x
  # x <- sym(x)
  
  for (g in c("M","F")){
      for(modl_name in c("~ EVERFSM_6", "~ IDACIScore")){ # TODO: reinstate},"~ IDACIScore * EthMaj","~ EVERFSM_6 * EthMaj")){
      
        message(g)
        # URNs <- results %>% filter(!!x == 1) %$% unique(URN)
        URNs <- results %>% filter_(paste0(x," == 1")) %$% unique(URN)
    
        #who could possibly take subject
        temp_results <- results %>% filter(URN %in% URNs) %>% filter(GENDER == g)
        message("URNS = ", length(URNs))
        n_students <- nrow(temp_results)
        # number of students in the model
        # cat_students <- temp_results %>% filter_(paste0(x,"==1")) %>% summarise(n = n()) %$% n
        message("n = ", n_students)
  
        # Spread_GCSE_All %>% filter(!is.na(X9040)) %>% filter(GENDER == "F", EthMaj=="CHIN")
        
        ### gender and PP
        if (n_students > 100000){
          temp <- summary(glm(paste(name, modl_name), data=temp_results, family=binomial))
          
          for(modl in rownames(temp$coefficients)){
              message(c(paste(modl_name,modl),name, g, n_students, 
                        temp$coefficients[modl,1],temp$coefficients[modl,2],temp$coefficients[modl,3], temp$coefficients[modl,4]))
              uptake_gender_regression <- rbind(uptake_gender_regression, 
                                                c(modl_name, modl, name, g, n_students, 
                                                  temp$coefficients[modl,1],temp$coefficients[modl,2],temp$coefficients[modl,3], temp$coefficients[modl,4]))
              names(uptake_gender_regression) <- c("model","output","subject", "gender", "n", "est", "std_error", "z", "p")
              
              uptake_gender_regression <- uptake_gender_regression %>%
                mutate(model= as.character(model),
                       output= as.character(output),
                       subject = as.character(subject),
                       gender = as.character(gender),
                       n = as.numeric(n),
                       est = as.numeric(est),
                       std_error = as.numeric(std_error),
                       z = as.numeric(z),
                       p = as.numeric(p))
          }
        }else{
          message("skipping")
        }
    }
  }
}


# percentage of each gender and PP that take computer science
# Spread_GCSE_All %>% filter(URN %in% URNs) %>%
#   mutate(computing = !is.na(X2610)) %>% 
#   group_by(GENDER, EVERFSM_6, computing) %>% 
#   summarise(n = n()) %>% 
#   ungroup() %>% 
#   group_by(GENDER, EVERFSM_6) %>%
#   mutate(per = (n / sum(n)))

temp <- Spread_GCSE_All %>% filter(URN %in% URNs) %>%
  mutate(computing = !is.na(X2610)) %>% 
  group_by(GENDER, EVERFSM_6, EthMaj, computing) %>% 
  summarise(n = n()) %>% 
  ungroup() %>% 
  group_by(GENDER, EVERFSM_6, EthMaj) %>%
  mutate(per = printper0(n / sum(n))) %>% ungroup() %>% arrange(GENDER, EVERFSM_6, computing)

temp <- temp %>% 
  filter(!is.na(EVERFSM_6)) %>% 
  filter(!is.na(EthMaj)) %>% 
  filter(EVERFSM_6  == 1) %>% 
  filter(computing  == TRUE)


results <- Spread_GCSE_All
results <- Spread_GCSE_All %>% filter(!is.na(X2610))
 
# General Maths ability for CS cohort
Ability_Maths <- results %>% group_by(GENDER) %>% summarise(mean = mean(X2210, na.rm=TRUE),
                                           SD = sd(X2210, na.rm=TRUE))
 
Ability_Computing <- results %>% group_by(GENDER) %>% summarise(mean = mean(X2610, na.rm=TRUE),
                                           SD = sd(X2610, na.rm=TRUE))
 
Ability_Computing_Maths <- results %>% group_by(GENDER) %>%
                                  filter(!is.na(X2610)) %>%
                                  summarise(mean = mean(X2610, na.rm=TRUE),
                                           SD = sd(X2610, na.rm=TRUE))
 
 
```
```{r Stats_Global}
 
year <- 2016
stat_total_student_number <- Spread_GCSE_All %$% nrow(.)
 
stat_total_qual_number <- nrow(Results_GCSE_All)
 
stat_total_comp_number <- Spread_GCSE_All %>% filter(!is.na(X2610)) %>% nrow()
stat_total_comp_female <- Spread_GCSE_All %>% filter(!is.na(X2610), GENDER == "F") %>% nrow()
stat_total_comp_male <- Spread_GCSE_All %>% filter(!is.na(X2610), GENDER == "M") %>% nrow()
 
stat_total_ict_number <- Spread_GCSE_All %>% filter(!is.na(X2650)) %>% nrow()
stat_total_ict_female <- Spread_GCSE_All %>% filter(!is.na(X2650), GENDER == "F") %>% nrow()
stat_total_ict_male <- Spread_GCSE_All %>% filter(!is.na(X2650), GENDER == "M") %>% nrow()
```
```{r health_of_fields}
health_gender <- healthOfField(Spread_GCSE_All %>% filter(!is.na(X2610)), "GENDER") %$% missingper
health_pp <- healthOfField(Spread_GCSE_All %>% filter(!is.na(X2610)), "EVERFSM_6") %$% missingper
health_Eth <- healthOfField(Spread_GCSE_All %>% filter(!is.na(X2610)), "EthMaj") %$% missingper
health_KS2Mat <- healthOfField(Spread_GCSE_All %>% filter(!is.na(X2610)), "KS2Mat") %$% missingper
health_GCSEMat <- healthOfField(Spread_GCSE_All %>% filter(!is.na(X2610)), "X2210") %$% missingper
 
```
```{r Table_grades, results="asis"}
temp <- read.csv(text="Grade,A*,A,B,C,D,E,F,G,U
                       Point equivalent, 8,7,6,5,4,3,2,1,0")
out_table_GCSE_grades <- xtable(temp,
       caption=paste0("GCSE grades and our numeric equivalent"),
       align = c('l', 'p{1.5in}|',rep('R{0.19in}',1), rep('R{0.17in}',8)),
       digits=c(0,0,0,0,0,0,0,0,0,0,0))
 
# rint(out_table_GCSE_grades, sanitize.text.function=function(x){gsub("A.", "A$*$",x,fixed=TRUE)})
 
data <- gather_spread(Spread_GCSE_All)
 
stat_one_GCSE <- data %>%
  group_by(PupilMatchingRefAnonymous) %>%
  summarise(total = n()) %>% ungroup() %>%
  group_by(total) %>%
  summarise(n = n()) %>% filter(total == 1) %$% n
 
stat_one_GCSE_per <- stat_one_GCSE / stat_total_student_number
 
stat_one_GCSE_comp <- gather_spread(Spread_GCSE_All %>% filter(!is.na(X2610))) %>%
  group_by(PupilMatchingRefAnonymous) %>%
  summarise(total = n()) %>% ungroup() %>%
  group_by(total) %>%
  summarise(n = n()) %>% filter(total == 1) %$% n
 
stat_one_GCSE_comp_per <- stat_one_GCSE_comp / stat_total_comp_number
 
schools_all <- Spread_GCSE_All %>% select(URN,schGender, X2610) %>%
  group_by(schGender) %>%
  distinct(URN) %>%
  summarise(n = n()) %>%
  filter(!is.na(schGender)) %>%
  ungroup() %>%
  mutate(per = n / sum(n))
schools_comp <- Spread_GCSE_All %>% select(URN,schGender, X2610) %>% filter(!is.na(X2610)) %>%
  group_by(schGender) %>%
  distinct(URN) %>%
  summarise(n = n()) %>%
  filter(!is.na(schGender)) %>%
  ungroup() %>%
  mutate(per = n / sum(n))
```

```{r Calc_Maths_profiles}
 
### KS2 Mathematics
 
FemaleKS2Mat <- OutputSubjectGroupAverageByWhat(Spread_GCSE_All %>%
                                                  filter(GENDER == "F", !is.na(KS2Mat), !is.na(X2210)),
                                                "X2610", "KS2Mat", 25) %>% select(SubjectName, n, mean, sd)
MaleKS2Mat <- OutputSubjectGroupAverageByWhat(Spread_GCSE_All %>%
                                                filter(GENDER == "M", !is.na(KS2Mat), !is.na(X2210)),
                                              "X2610", "KS2Mat", 25) %>% select(SubjectName, n, mean, sd)
FemaleGCSEMat <- OutputSubjectGroupAverageByWhat(Spread_GCSE_All %>%
                                                   filter(GENDER == "F", !is.na(KS2Mat), !is.na(X2210)),
                                                 "X2610", "X2210", 25) %>% select(SubjectName, n, mean, sd)
MaleGCSEMat <- OutputSubjectGroupAverageByWhat(Spread_GCSE_All %>%
                                                 filter(GENDER == "M", !is.na(KS2Mat), !is.na(X2210)),
                                               "X2610", "X2210", 25) %>% select(SubjectName, n, mean, sd)
 
 
 
MathsTable <- left_join(FemaleKS2Mat, MaleKS2Mat, by="SubjectName")
MathsTable$n <- MathsTable$n.x + MathsTable$n.y
MathsTable$FemaleKS2 <- paste0(printper(MathsTable$mean.x,2), "(", printper(MathsTable$sd.x,2), ")")
MathsTable$MaleKS2 <- paste0(printper(MathsTable$mean.y,2), "(", printper(MathsTable$sd.y,2), ")")
 
MathsTable <- MathsTable[c("SubjectName", "n", "n.x", "FemaleKS2", "n.y", "MaleKS2")]
names(MathsTable) <- c("SubjectName", "n", "Females", "Female KS2 Maths M(SD)", "Males", "Male KS2 Maths M(SD)")
 
MathsTable <- left_join(MathsTable, FemaleGCSEMat[c("SubjectName", "mean", "sd")], by="SubjectName")
MathsTable <- left_join(MathsTable, MaleGCSEMat[c("SubjectName", "mean", "sd")], by="SubjectName")
MathsTable$FemaleGCSE <- paste0(printper(MathsTable$mean.x,2), "(", printper(MathsTable$sd.x,2), ")")
MathsTable$MaleGCSE <- paste0(printper(MathsTable$mean.y,2), "(", printper(MathsTable$sd.y,2), ")")
 
MathsTable <- MathsTable[c("SubjectName", "n", "Females", "Female KS2 Maths M(SD)", "FemaleGCSE", "Males", "Male KS2 Maths M(SD)", "MaleGCSE")]
MathsTable <- MathsTable %>%
  arrange(desc(n)) %>%
  filter(!is.na(n)) %>%
  top_n(20, wt=`Female KS2 Maths M(SD)`) %>%
  arrange(desc(`Female KS2 Maths M(SD)`))
 
names(MathsTable) <- c("SubjectName", "n", "Females", "KS2 M(SD)", "GCSE M(SD)", "Males", "KS2 M(SD)", "GCSE M(SD)")
 
out_MathsTable <- xtable(MathsTable,
               caption="Mathematics entry profiles by subject",
               align = c('l', 'p{0.8in}|',
                         "R{0.5in}",
                         "R{0.5in}",
                         "R{0.6in}",
                         "R{0.6in}|",
                         "R{0.5in}",
                         "R{0.6in}",
                         "R{0.6in}"),
               digits= c(0,0,0,0,2,2,0,2,2))
 
# independent 2-group t-test, adding cohen's d

KS2T.Test.Comp <- ttest_d(Spread_GCSE_All %>% 
                            filter(GENDER == "F", !is.na(X2610)) %$% 
                            KS2Mat,
                          Spread_GCSE_All %>% 
                            filter(GENDER == "M", !is.na(X2610)) %$% 
                            KS2Mat)
KS2T.Test.ICT <- ttest_d(Spread_GCSE_All %>% 
                           filter(GENDER == "F", 
                                  !is.na(X2650)) %$% 
                           KS2Mat,
                         Spread_GCSE_All %>% 
                           filter(GENDER == "M", 
                                  !is.na(X2650)) %$% 
                           KS2Mat)
KS2T.Test.All <- ttest_d(Spread_GCSE_All %>% filter(GENDER == "F") %$% KS2Mat,
                    Spread_GCSE_All %>% filter(GENDER == "M") %$% KS2Mat)

KS2T.Test.Comp.F.vs.All <- ttest_d(Spread_GCSE_All %>% filter(GENDER == "F", !is.na(X2610)) %$% KS2Mat,
                    Spread_GCSE_All %>% filter(GENDER == "F", is.na(X2610)) %$% KS2Mat)
KS2T.Test.Comp.M.vs.All <- ttest_d(Spread_GCSE_All %>% filter(GENDER == "M", !is.na(X2610)) %$% KS2Mat,
                    Spread_GCSE_All %>% filter(GENDER == "M", is.na(X2610)) %$% KS2Mat)
 
GCSEMathT.Comp <- ttest_d(Spread_GCSE_All %>% filter(GENDER == "F", !is.na(X2610)) %$% X2210,
                          Spread_GCSE_All %>% filter(GENDER == "M", !is.na(X2610)) %$% X2210)

GCSEMathT.ICT <- ttest_d(Spread_GCSE_All %>% filter(GENDER == "F", !is.na(X2650)) %$% X2210,
                          Spread_GCSE_All %>% filter(GENDER == "M", !is.na(X2650)) %$% X2210)
GCSEMathT.All <- ttest_d(Spread_GCSE_All %>% filter(GENDER == "F") %$% X2210,
                          Spread_GCSE_All %>% filter(GENDER == "M") %$% X2210)
 
GCSE.Test.Comp.F.vs.All <- ttest_d(Spread_GCSE_All %>% filter(GENDER == "F", !is.na(X2610)) %$% X2210,
                    Spread_GCSE_All %>% filter(GENDER == "F", is.na(X2610)) %$% X2210)
GCSE.Test.Comp.M.vs.All <- ttest_d(Spread_GCSE_All %>% filter(GENDER == "M", !is.na(X2610)) %$% X2210,
                    Spread_GCSE_All %>% filter(GENDER == "M", is.na(X2610)) %$% X2210)

### KS2 SATS means
 
 
Female_CS_KSMat_mean <- Spread_GCSE_All %>%
  filter(GENDER == "F", !is.na(X2610)) %>%
  summarise(KS2Mat = mean(KS2Mat, na.rm = TRUE)) %$% KS2Mat
Male_CS_KSMat_mean <- Spread_GCSE_All %>%
  filter(GENDER == "M", !is.na(X2610)) %>%
  summarise(KS2Mat = mean(KS2Mat, na.rm = TRUE)) %$% KS2Mat
 
Female_All_KSMat_mean <- Spread_GCSE_All %>%
  filter(GENDER == "F") %>%
  summarise(KS2Mat = mean(KS2Mat, na.rm = TRUE)) %$% KS2Mat
Male_All_KSMat_mean <- Spread_GCSE_All %>%
  filter(GENDER == "M") %>%
  summarise(KS2Mat = mean(KS2Mat, na.rm = TRUE)) %$% KS2Mat
 
Female_ICT_KSMat_mean <- Spread_GCSE_All %>%
  filter(GENDER == "F", !is.na(X2650)) %>%
  summarise(KS2Mat = mean(KS2Mat, na.rm = TRUE)) %$% KS2Mat
Male_ICT_KSMat_mean <- Spread_GCSE_All %>%
  filter(GENDER == "M", !is.na(X2650)) %>%
  summarise(KS2Mat = mean(KS2Mat, na.rm = TRUE)) %$% KS2Mat
 
Female_nonCS_KSMat_mean <- Spread_GCSE_All %>%
  filter(GENDER == "F", is.na(X2610)) %>%
  summarise(KS2Mat = mean(KS2Mat, na.rm = TRUE)) %$% KS2Mat
Male_nonCS_KSMat_mean <- Spread_GCSE_All %>%
  filter(GENDER == "M", is.na(X2610)) %>%
  summarise(KS2Mat = mean(KS2Mat, na.rm = TRUE)) %$% KS2Mat
 
### Maths GCSE means
Female_CS_GCSE_mean <- Spread_GCSE_All %>%
  filter(GENDER == "F", !is.na(X2610)) %>%
  summarise(X2210 = mean(X2210, na.rm = TRUE)) %$% X2210
Male_CS_GCSE_mean <- Spread_GCSE_All %>%
  filter(GENDER == "M", !is.na(X2610)) %>%
  summarise(X2210 = mean(X2210, na.rm = TRUE)) %$% X2210
 
Female_All_GCSE_mean <- Spread_GCSE_All %>%
  filter(GENDER == "F") %>%
  summarise(X2210 = mean(X2210, na.rm = TRUE)) %$% X2210
Male_All_GCSE_mean <- Spread_GCSE_All %>%
  filter(GENDER == "M") %>%
  summarise(X2210 = mean(X2210, na.rm = TRUE)) %$% X2210
 
Female_ICT_GCSE_mean <- Spread_GCSE_All %>%
  filter(GENDER == "F", !is.na(X2650)) %>%
  summarise(X2210 = mean(X2210, na.rm = TRUE)) %$% X2210
Male_ICT_GCSE_mean <- Spread_GCSE_All %>%
  filter(GENDER == "M", !is.na(X2650)) %>%
  summarise(X2210 = mean(X2210, na.rm = TRUE)) %$% X2210
 
Female_nonCS_GCSE_mean <- Spread_GCSE_All %>%
  filter(GENDER == "F", is.na(X2610)) %>%
  summarise(X2210 = mean(X2210, na.rm = TRUE)) %$% X2210
Male_nonCS_GCSE_mean <- Spread_GCSE_All %>%
  filter(GENDER == "M", is.na(X2610)) %>%
  summarise(X2210 = mean(X2210, na.rm = TRUE)) %$% X2210
 
 
```
```{r GSCEMeans}
### GCSE Maths
 
Female_Comp_GCSEMath_mean <- Spread_GCSE_All %>%
  filter(GENDER == "F", !is.na(X2610), !is.na(X2210)) %>%
  summarise(X2210 = mean(X2210, na.rm = TRUE)) %$% X2210
Male_Comp_GCSEMath_mean <- Spread_GCSE_All %>%
  filter(GENDER == "M", !is.na(X2610), !is.na(X2210)) %>%
  summarise(X2210 = mean(X2210, na.rm = TRUE)) %$% X2210
 
Female_All_GCSEMath_mean <- Spread_GCSE_All %>%
  filter(GENDER == "F", !is.na(X2210)) %>%
  summarise(X2210 = mean(X2210, na.rm = TRUE)) %$% X2210
Male_All_GCSEMath_mean <- Spread_GCSE_All %>%
  filter(GENDER == "M", !is.na(X2210)) %>%
  summarise(X2210 = mean(X2210, na.rm = TRUE)) %$% X2210
 
##### Regional summary for female participation
table_GCSE_provider_region <-
           OutputSubectStudentSchoolsByCriteria(Spread_GCSE_All %>% filter(GENDER == "F"),
                                                subject_code, "region", grades = TRUE)

```

```{r calc_urban_schools}
##### Urban Rural summary for female participation
table_GCSE_provider_urban_rural_female <-
           OutputSubectStudentSchoolsByCriteria(Spread_GCSE_All %>% filter(GENDER == "F"), subject_code, "UrbanRuralCombine", grades = TRUE)
 
table_GCSE_provider_urban_rural_male <-
           OutputSubectStudentSchoolsByCriteria(Spread_GCSE_All %>% filter(GENDER == "M"), subject_code, "UrbanRuralCombine", grades = TRUE)
 
# Type | Total | Females | Female % | Male % |
```

```{r calc_math_schools}
 
# difference in maths profiles between schools
#get mean maths scores for each school
meanMaths <- Spread_GCSE_All %>% filter(!is.na(X2210)) %>% group_by(URN) %>% select(X2210, X2610) %>% summarise(meanMath = mean(X2210))
 
meanCSSchools <- Spread_GCSE_All %>% filter(!is.na(X2210),!is.na(X2610)) %>% group_by(URN) %>% select(X2210, X2610) %>% summarise(meanMath = mean(X2210))
 
meannonCSSchools <- meanMaths %>% filter(!URN %in% meanCSSchools$URN)
 
school_non_cs_mean <- mean(meannonCSSchools$meanMath)
school_non_cs_n <- nrow(meannonCSSchools)
school_cs_mean <- mean(meanCSSchools$meanMath)
school_cs_n <- nrow(meanCSSchools)
 
#calc stats for ICT
 
meanMaths <- Spread_GCSE_All %>% 
  filter(!is.na(X2210)) %>% 
  group_by(URN) %>% 
  select(X2210, X2650) %>% 
  summarise(meanMath = mean(X2210))
 
meanICTSchools <- Spread_GCSE_All %>% 
  filter(!is.na(X2210),!is.na(X2650)) %>% 
  group_by(URN) %>% 
  select(X2210, X2650) %>% 
  summarise(meanMath = mean(X2210))
 
meannonICTSchools <- meanMaths %>% filter(!URN %in% meanICTSchools$URN)
 
school_non_ict_mean <- mean(meannonICTSchools$meanMath)
school_non_ict_n <- nrow(meannonICTSchools)
school_ict_mean <- mean(meanICTSchools$meanMath)
school_ict_n <- nrow(meanICTSchools)

 
```

```{r calc_gender_schools}
##### School gender
 
table_GCSE_provider_gender_female <-
  OutputSubectStudentSchoolsByCriteria(Spread_GCSE_All %>% filter(GENDER == "F"), subject_code, "schGender", grades = TRUE)
 
table_GCSE_provider_gender_male<-
  OutputSubectStudentSchoolsByCriteria(Spread_GCSE_All %>% filter(GENDER == "M"), subject_code, "schGender", grades = TRUE)

```

```{r child="GENDER_2018_commentary/Gender_Background.Rmd", results="asis", cache=FALSE}
```

![Outline of the English school system by age, key stage and major exam](figures/school_stages.pdf)

```{r child="GENDER_2018_commentary/Gender_Background1.Rmd", results="asis", cache=FALSE}
```

```{r child="GENDER_2018_commentary/Gender_Background2.Rmd", results="asis", cache=FALSE}
```

```{r child="GENDER_2018_commentary/Gender_Female_participation.Rmd", results="asis", cache=FALSE}
```

```{r child="GENDER_2018_commentary/Gender_Female_attainment.Rmd", results="asis", cache=FALSE}
```

```{r child="GENDER_2018_commentary/Gender_Research_questions.Rmd", results="asis", cache=FALSE}
```

```{r child="GENDER_2018_commentary/Gender_Methodology.Rmd", results="asis", cache=FALSE}
```

```{r child="GENDER_2018_commentary/Gender_Design.Rmd", results="asis", cache=FALSE}
```

```{r child="GENDER_2018_commentary/Gender_Participants.Rmd", results="asis", cache=FALSE}
```

```{r child="GENDER_2018_commentary/Gender_Data_analysis.Rmd", results="asis", cache=FALSE}
```

```{r child="GENDER_2018_commentary/Gender_Findings.Rmd", results="asis", cache=FALSE}
```

```{r child="GENDER_2018_commentary/Gender_Dataset_description.Rmd", results="asis", cache=FALSE}
```

```{r child="GENDER_2018_commentary/Gender_Participation.Rmd", results="asis", cache=FALSE}
```

```{r child="GENDER_2018_commentary/Gender_Mathematics_profiles.Rmd", results="asis", cache=FALSE}
```

```{r out_Maths_profile, results="asis", cache = TRUE}
out_MathsTable
```

```{r calc_gender_pp, results="asis", cache = TRUE}
# TODO: insert this into main text % of students from each grouping taking the subject
# whether they take computing, get the URNs
URNs <- Spread_GCSE_All %>% filter(!is.na(EVERFSM_6), !is.na(X2610)) %$% unique(URN)

# URNs <- unique(Spread_GCSE_All$URN)

CS_PP_Gender <- Spread_GCSE_All %>% filter(URN %in% URNs) %>%
  mutate(CS = !is.na(X2610)) %>% 
  group_by(GENDER, EVERFSM_6, CS) %>% 
  summarise(n = n()) %>% 
  ungroup() %>% 
  group_by(GENDER, EVERFSM_6) %>%
  mutate(`% of gender/pupil premium combo` = printper0(n / sum(n))) %>% 
  filter(!is.na(EVERFSM_6)) %>% 
  filter(CS  == TRUE) %>% 
  select(-CS) %>%
  rename(`CS students` =n) %>% ungroup()

# whether they take computing, get the URNs
URNs <- Spread_GCSE_All %>% filter(!is.na(EVERFSM_6), !is.na(X2650)) %$% unique(URN)

ICT_PP_Gender <- Spread_GCSE_All %>% filter(URN %in% URNs) %>%
  mutate(ICT = !is.na(X2650)) %>% 
  group_by(GENDER, EVERFSM_6, ICT) %>% 
  summarise(n = n()) %>% 
  ungroup() %>% 
  group_by(GENDER, EVERFSM_6) %>%
  mutate(`% of gender/pupil premium combo` = printper0(n / sum(n))) %>% 
  filter(!is.na(EVERFSM_6)) %>% 
  filter(ICT  == TRUE) %>%
  select(-ICT) %>%
  rename(`ICT students` =n) %>% ungroup()

# spread(ICT_PP_Gender %>% 
#          mutate(students = 
#                   paste0(`ICT students`, "(",`% of gender/pupil premium combo`,"%)")) %>%
#          select(GENDER, EVERFSM_6, students), EVERFSM_6, students)
# 
# spread(CS_PP_Gender %>% 
#          mutate(students = 
#                   paste0(`CS students`, "(",`% of gender/pupil premium combo`,"%)")) %>%
#          select(GENDER, EVERFSM_6, students), EVERFSM_6, students)

temp <- cbind(CS_PP_Gender %>% mutate(EVERFSM_6 = ifelse(EVERFSM_6 == 1, "PP", "non-PP")), 
              ICT_PP_Gender %>% select(-GENDER, -EVERFSM_6))


names(temp) <- c("Gender", "","CS students", "% of gender/pupil premium combo", "ICT students","% of gender/pupil premium combo")

out_table_PP_Gen <- xtable(temp, paste0("GCSE pupil premium representation by gender"),
                           align = autosizeColumns(temp,
                               firstfields= c(0.5, 0.7), page_width=4.7),
                            digits= autodecimalColumns(temp,
                                 firstfields=
                                   rep(length(names(temp)))))

######## the above is currently dropped

# work out working class and gender stats

### TOOD: get this to show % of population

CS_PP_Gen <- OutputPPGender(Spread_GCSE_All, subject_code)
names(CS_PP_Gen) <- c("Gender","Pupil premium","CS students","% of students taking CS")
ICT_PP_Gen <- OutputPPGender(Spread_GCSE_All, quo(X2650))
names(ICT_PP_Gen) <- c("Gender","Pupil premium","ICT students","% of students taking ICT")
 
table_PP_Gen <- left_join(CS_PP_Gen, ICT_PP_Gen, by=c("Gender", "Pupil premium"))

table_PP_Gen <- table_PP_Gen %>% mutate(`Pupil premium` = ifelse(`Pupil premium` == 1, "PP", "non-PP"))

names(table_PP_Gen) <- c("Gender","","CS students","% of students taking CS","ICT students","% of students taking ICT")

out_table_PP_Gen <- xtable(table_PP_Gen, paste0("GCSE pupil premium representation by gender"),
                           align = autosizeColumns(table_PP_Gen,
                               firstfields= c(0.5, 0.7), page_width=4.7),
                            digits= autodecimalColumns(table_PP_Gen,
                                 firstfields=
                                   rep(length(names(table_PP_Gen)))))
 
CS_PP_Female <- CS_PP_Gen %>% filter(Gender == "F", `Pupil premium` == 1) %$% `% of students taking CS`
CS_PP_Male <- CS_PP_Gen %>% filter(Gender == "M", `Pupil premium` == 1) %$% `% of students taking CS`
CS_PP_Female_n <- CS_PP_Gen %>% filter(Gender == "F", `Pupil premium` == 1) %$% `CS students`
CS_PP_Male_n <- CS_PP_Gen %>% filter(Gender == "M", `Pupil premium` == 1) %$% `CS students`
 
ICT_PP_Female <- ICT_PP_Gen %>% filter(Gender == "F", `Pupil premium` == 1) %$% `% of students taking ICT`
ICT_PP_Male <- ICT_PP_Gen %>% filter(Gender == "M", `Pupil premium` == 1) %$% `% of students taking ICT`
 
# get PP premium stats for the whole population
pop_PP <- Spread_GCSE_All %>% ungroup() %>%
  filter(!is.na(EVERFSM_6)) %>%
  mutate(total = n()) %>%
  group_by(EVERFSM_6) %>%
  summarise(total = max(total),
            sub_total = n(),
            per = sub_total / total)
 
pop_non_PP <- pop_PP %>% filter(EVERFSM_6 == 0) %$% per
pop_PP <- pop_PP %>% filter(EVERFSM_6 == 1) %$% per
 
```

```{r child="GENDER_2018_commentary/Gender_Gender_ethnicity_socioeconomic_0.Rmd", results="asis", cache=FALSE}
```

```{r out_Eth_Gen_PP, results="asis", cache=FALSE}
print(out_table_PP_Gen, hline.after = c(-1,0,2))
# 
```

```{r calc_gender_eth_pp}

### for computing
URNs <- Spread_GCSE_All %>% filter(!is.na(X2610)) %$% unique(URN)

temp <- Spread_GCSE_All %>% filter(URN %in% URNs) %>%
  mutate(computing = !is.na(X2610)) %>% 
  group_by(GENDER, EVERFSM_6, EthMaj, computing) %>% 
  summarise(n = n()) %>% 
  ungroup() %>% 
  group_by(GENDER, EVERFSM_6, EthMaj) %>%
  mutate(per = printper0(n / sum(n))) %>% ungroup() %>% arrange(GENDER, EVERFSM_6, computing)

temp <- temp %>% 
  filter(!is.na(EVERFSM_6)) %>% 
  filter(!is.na(EthMaj)) %>% 
  filter(computing  == TRUE) %>%
  select(-computing)

temp_CS <- left_join(temp %>% select(-per) %>% spread(EVERFSM_6,n) %>% rename(`csn_0`=`0`, `csn_1`=`1`),
          temp %>% select(-n) %>% spread(EVERFSM_6,per) %>% rename(`csper_0`=`0`, `csper_1`=`1`),
          by=c("GENDER"="GENDER", "EthMaj"="EthMaj"))

### for ICT
URNs <- Spread_GCSE_All %>% filter(!is.na(X2650)) %$% unique(URN)

temp <- Spread_GCSE_All %>% filter(URN %in% URNs) %>%
  mutate(computing = !is.na(X2650)) %>% 
  group_by(GENDER, EVERFSM_6, EthMaj, computing) %>% 
  summarise(n = n()) %>% 
  ungroup() %>% 
  group_by(GENDER, EVERFSM_6, EthMaj) %>%
  mutate(per = printper0(n / sum(n))) %>% ungroup() %>% arrange(GENDER, EVERFSM_6, computing)

temp <- temp %>% 
  filter(!is.na(EVERFSM_6)) %>% 
  filter(!is.na(EthMaj)) %>% 
  filter(computing  == TRUE) %>%
  select(-computing)

temp_ICT <- left_join(temp %>% select(-per) %>% spread(EVERFSM_6,n) %>% rename(`itn_0`=`0`, `itn_1`=`1`),
          temp %>% select(-n) %>% spread(EVERFSM_6,per) %>% rename(`itper_0`=`0`, `itper_1`=`1`),
          by=c("GENDER"="GENDER", "EthMaj"="EthMaj"))

### join results together
eth_pp_gender_table <- left_join(temp_CS,temp_ICT, by=c("GENDER"="GENDER", "EthMaj"="EthMaj"))

eth_pp_gender_table <- eth_pp_gender_table %>% 
                        mutate(csn_0 =paste0(csn_0, " (",printper(csper_0,1),"%)"),
                               csn_1 =paste0(csn_1, " (",printper(csper_1,1),"%)"),
                               itn_0 =paste0(itn_0, " (",printper(itper_0,1),"%)"),
                               itn_1 =paste0(itn_1, " (",printper(itper_1,1),"%)")) %>%
                              select(-csper_0, -csper_1, -itper_0, -itper_1)

addtorow_comp <- list()
addtorow_comp$pos <- list(0,0)
addtorow_comp$command <- c(" & & \\multicolumn{2}{c}{Computer Science} & \\multicolumn{2}{c}{ICT} \\\\\n",
  "Gender & Ethnicity & non-PP & PP & non-PP & PP \\\\\n")

out_table_G_PP_Eth_CS_ICT <- xtable(eth_pp_gender_table,
                                    paste0("GCSE CS uptake as percentage of school population by gender, ethnicity and pupil premium (PP)"),
                           align = autosizeColumns(eth_pp_gender_table,
                               firstfields= c(0.5, 0.5), page_width=4.7),
                            digits= autodecimalColumns(eth_pp_gender_table,
                                 firstfields=
                                   rep(length(names(eth_pp_gender_table)))))
```

```{r Build_logistical_model}

# returns text of whether a logistical model is good or not
logisiticPseudoR2s <- function(logModel) {
  # logModel <- table_data
  message("building logistic regression descriptors, this might take some time")
  
  R2_df <- data.frame(b = numeric(),
                      p = character(),
                      chi = numeric(),
                      chidf = numeric(),
                      chip = numeric(),
                      R2_hos = numeric(),
                      R2_cox = numeric(),
                      R2_nag = numeric(),
                      R2_i_25 = numeric(),
                      R2_i_975 = numeric(),
                      R2_v_25 = numeric(),
                      R2_v_975 = numeric(),
                      desc = character())
  R2_df <- bind_rows(R2_df, as.data.frame(c(0)))
  
  chidf <- logModel$df.null - logModel$df.residual
  chi <- logModel$null.deviance - logModel$deviance
  chi_p <- 1-pchisq(chi, chidf)
  
  dev <- logModel$deviance
  nullDev <- logModel$null.deviance
  modelN <- length(logModel$fitted.values)
  R.l <- 1 - dev / nullDev
  R.cs <- 1 - exp( -(nullDev - dev) / modelN)
  R.n <- R.cs / (1 - (exp( -(nullDev / modelN))))
  
  intervals <-exp(confint(logModel))
  
  R2_df$b <- printper(logModel$coefficients[2],3)
  R2_df$p <- "???"
  R2_df$chi <- printper(chi,2)
  R2_df$chidf <- printper(chidf,0)
  R2_df$chip <- printper(chi_p,3)
  R2_df$R2_hos <- round(R.l, 3)
  R2_df$R2_cox <- round(R.cs, 3)
  R2_df$R2_nag <- round(R.n, 3)
  R2_df$R2_i_25 <- intervals["(Intercept)","2.5 %"]
  R2_df$R2_i_975 <- intervals["(Intercept)","97.5 %"]
  R2_df$R2_v_25 <- intervals[2,"2.5 %"]
  R2_df$R2_v_975 <- intervals[2,"97.5 %"]
  R2_df$desc <- paste0("&chi;^2^(",chidf,")=",chi,", _p_=",printper(chi_p,3),"\n
                        Pseudo R^2^ for logistics regression\n
                        Hosmer and Lemeshow R^2^: \t", round(R.l, 3), "\n
                        Cox and Snell R^2^\t: ", round(R.cs, 3), "\n
                        Nagelkerke R^2\t: ", round(R.n, 3), "\n")

  
  
  return(R2_df)
}


results <- cbind(Spread_GCSE_All %>% select(PupilMatchingRefAnonymous, URN, GENDER, EthMin, EthMaj, EVERFSM_6, IDACIScore, schGender), 
                 Spread_GCSE_All %>% select(grep("X", names(Spread_GCSE_All))) %>%
                   mutate_all(., ~(ifelse(is.na(.), as.numeric(0), as.numeric(1))))) %>%
  filter(!is.na(EthMaj), !is.na(EVERFSM_6), !is.na(IDACIScore))


URNs <- results %>% filter(X2610 == 1) %$% unique(URN)

cs_results <- results %>% 
  filter(URN %in% URNs) %>% 
  select(PupilMatchingRefAnonymous, GENDER, EthMaj, 
         EVERFSM_6, IDACIScore, schGender, X2610) %>%
  gather(subject, val, -c(PupilMatchingRefAnonymous, 
                          GENDER, EthMaj, EVERFSM_6, IDACIScore,schGender)) %>%
  mutate(subject = ifelse(subject == "X2610", "CS", "ICT"))


URNs <- results %>% filter(X2650 == 1) %$% unique(URN)

ict_results <- results %>% 
  filter(URN %in% URNs) %>% 
  select(PupilMatchingRefAnonymous, GENDER, EthMaj, 
         EVERFSM_6, IDACIScore, schGender, X2650) %>%
  gather(subject, val, -c(PupilMatchingRefAnonymous, 
                          GENDER, EthMaj, EVERFSM_6, IDACIScore,schGender)) %>%
  mutate(subject = ifelse(subject == "X2610", "CS", "ICT"))

temp_results <- rbind(cs_results, ict_results)

## work out decile effect of the IDACI score

female_results <- temp_results %>% 
  filter(GENDER == "F") %>% 
  group_by(subject) %>%
  mutate(decile = ntile(IDACIScore, 10)) %>% 
  group_by(subject, decile) %>%
  summarise(total = n(),
            totalSub = sum(val)) %>%
  mutate(Gender = "F")

male_results <- temp_results %>% 
  filter(GENDER == "M") %>% 
  group_by(subject) %>%
  mutate(decile = ntile(IDACIScore, 10)) %>% 
  group_by(subject, decile) %>%
  summarise(total = n(),
            totalSub = sum(val)) %>%
  mutate(Gender = "M")

all_results <- rbind(female_results, male_results) %>% 
  mutate(perSub = printper0(totalSub/total)) %>%
  mutate(decile = decile)

# 10 bars with lm fitting lines for each gender
graph_decile_idaci <- ggplot(data = all_results, aes(as.factor(decile), perSub, fill=Gender)) + 
  geom_bar(stat = "Identity", position=position_dodge()) +
  geom_smooth(method = "lm", 
              se = TRUE, 
              data = all_results, 
              aes(as.numeric(decile), perSub, fill=Gender)) +
  geom_text(aes(as.factor(decile), 
                perSub,
                label=format(round(perSub, 2), nsmall=1),
                vjust = ifelse(Gender=="F", -0.15, 1.1)),
            hjust=1.10,
            angle=90,
            colour="white",
            size=3) +
  labs(x = "IDACI deciles (higher values correspond with increased poverty)",
     y = "% taking subject") +
  theme(axis.title=element_text(size=axis_size),
        legend.position="bottom",
        legend.text=element_text(size=rel(0.5)),
        legend.title=element_text(size=rel(0.5))) +
  facet_grid(. ~ subject, scales = "free")
  

# logistic plot
# temp_results <- temp_results %>% mutate(StandardError = ifelse(EthMaj=="CHIN", FALSE, TRUE))
# 
# log_stats <- temp_results %>% 
#   mutate(gender_loc = ifelse(GENDER == "M", 0.06, 0.1)) %>%
#   mutate(gender_loc = ifelse(subject=="CS" & EthMaj != "CHIN", gender_loc + 0.34, gender_loc)) %>%
#   group_by(subject, EthMaj, GENDER) %>% 
#   summarise(modl_b = summary(glm(IDACIScore ~ val, family = binomial))$coefficients[2,1],
#             modl_p = summary(glm(IDACIScore ~ val, family = binomial))$coefficients[2,4],
#             gender_loc = unique(gender_loc)) %>%
#   mutate(modl_star = convertStar(p=modl_p))
# 
# graph_eth_idaci <- ggplot(data=temp_results, aes(IDACIScore, val, color=GENDER)) +
#   stat_smooth(method="glm", method.args = list(family = "binomial"), se = FALSE, formula=y~x,
#               alpha=0.2, size=1, aes(fill=GENDER))  +
#   facet_grid(subject ~ EthMaj )   + 
#   labs(x = "IDACI (higher values correspond with increased poverty)",
#        y = "chance of taking subject") + 
#   theme(axis.text.x = element_text(angle = 90, hjust = 12),
#         legend.position="bottom",
#         axis.title=element_text(size=axis_size)) +
#   expand_limits(x = 0, y = 0) +
#   geom_text(aes(x=0.44, 
#                 y=gender_loc, 
#                 label=paste0(" b= ",printper(modl_b,3), " ", modl_star)), 
#                 #label=paste0("p=",printper(modl_p,3)," b=",printper(modl_b,3))), 
#             data=log_stats, size=2.5)


#### adjusted the logistic plot to represent same data through quartiles
#### NOTE: quartiles are given for male and female subject populations, not ethnicities.
graph_eth_data <- temp_results %>% group_by(subject, GENDER) %>% 
  mutate(quartile = ntile(IDACIScore, 4)) %>% 
  group_by(subject, EthMaj, GENDER, quartile) %>%
  summarise(sub_per = printper0(mean(val)),
            total = n(),
            reps = total * (mean(val))) %>% # so we can check that a bar isn't representing 5 or fewer students
  filter(!EthMaj %in% c("AOEG", "UNCL") )

graph_eth_idaci <- ggplot(data=graph_eth_data, aes(quartile, sub_per, fill=GENDER)) +
  geom_bar(stat = "Identity", position=position_dodge()) +
  stat_smooth(method="lm", formula=y~x, se=FALSE,
              alpha=0.2, size=1, aes(fill=GENDER))  +
  geom_text(aes(quartile, 
                sub_per,
                label=format(round(sub_per, 2), nsmall=1),
                vjust = ifelse(GENDER=="F", -0.15, 1.1)),
            hjust=1.10,
            angle=90,
            colour="white",
            size=2.5) +
  facet_grid( subject ~ as.character(EthMaj)) +
   labs(x = "IDACI quartiles (higher values correspond with increased poverty)",
       y = "% taking subject") + 
  theme(legend.position="bottom",
        axis.title=element_text(size=axis_size),
        legend.text=element_text(size=rel(0.5)),
        legend.title=element_text(size=rel(0.5)))

```

```{r build_table_G_PP_Eth_CS_ICT, results="asis", cache = TRUE}

###################
###### Build tables
###################

# Adjust the factors and levels to put WHIT (the biggest population) first
# temp_results <- rbind(cs_results, ict_results)
temp_results <- temp_results %>% group_by(EthMaj) %>% mutate(n=n()) %>% ungroup() %>% arrange(desc(n)) %>% select(-n) 
temp_results$EthMaj <- factor(temp_results$EthMaj, unique(temp_results$EthMaj))

# levels(temp_results$EthMaj)
# 
# modl_data <- temp_results %>% filter(subject == "CS", GENDER == "M")
# glm(val ~ IDACIScore * EthMaj, family = "binomial", data=modl_data)

modl_data <- temp_results %>% filter(subject == "CS", GENDER == "M")
table_data <- glm(val ~ IDACIScore * EthMaj, family = "binomial", data=modl_data)
out_male_CS_IDACI_EthMaj <- xtable(table_data,
                                     caption="Model: Males taking CS ~ IDACI * Ethnic grouping")

modl_data <- temp_results %>% filter(subject == "CS", GENDER == "F")
table_data <- glm(val ~ IDACIScore * EthMaj, family = "binomial", data=modl_data)
out_female_CS_IDACI_EthMaj <- xtable(table_data,
                                     caption="Model: Females taking CS predicted by IDACI * Ethnic grouping")

modl_data <- temp_results %>% filter(subject == "ICT", GENDER == "M")
table_data <- glm(val ~ IDACIScore * EthMaj, family = "binomial", data=modl_data)
out_male_ICT_IDACI_EthMaj <- xtable(glm(val ~ IDACIScore * EthMaj, family = "binomial", data=modl_data),
                                     caption="Model: Males taking ICT ~ IDACI * Ethnic grouping")

modl_data <- temp_results %>% filter(subject == "ICT", GENDER == "F")
table_data <- glm(val ~ IDACIScore * EthMaj, family = "binomial", data=modl_data)
out_female_ICT_IDACI_EthMaj <- xtable(table_data,
                                     caption="Model: Females taking ICT ~ IDACI * Ethnic grouping")

modl_data <- temp_results %>% filter(subject == "CS", GENDER == "M")
table_data <- glm(val ~ IDACIScore, family = "binomial", data=modl_data)
modl_CS_IDACI_M_R <- logisiticPseudoR2s(table_data)
out_male_CS_IDACI <- xtable(table_data,
                            caption="Model: Males taking CS predicted by IDACI score")

modl_data <- temp_results %>% filter(subject == "CS", GENDER == "F")
table_data <- glm(val ~ IDACIScore, family = "binomial", data=modl_data)
modl_CS_IDACI_F_R <- logisiticPseudoR2s(table_data)
out_female_CS_IDACI <- xtable(table_data,
                            caption="Model: Females taking CS predicted by IDACI score")

# this graph plots raw IDACI against change of taking CS
# modl_data <- temp_results %>% filter(subject == "CS")
# ggplot(modl_data, aes(y=val, x = IDACIScore, colour=GENDER)) +
#   # geom_point() +
#   geom_smooth(method = "glm", 
#     method.args = list(family = "binomial"), 
#     se = TRUE)

modl_data <- temp_results %>% filter(subject == "ICT", GENDER == "M")
table_data <- glm(val ~ IDACIScore, family = "binomial", data=modl_data)
modl_ICT_IDACI_M_R <- logisiticPseudoR2s(table_data)
out_male_ICT_IDACI <- xtable(table_data,
                            caption="Model: Males taking ICT predicted by IDACI score")

modl_data <- temp_results %>% filter(subject == "ICT", GENDER == "F")
table_data <- glm(val ~ IDACIScore, family = "binomial", data=modl_data)
modl_ICT_IDACI_F_R <- logisiticPseudoR2s(table_data)
out_female_ICT_IDACI <- xtable(table_data,
                            caption="Model: Females taking ICT predicted by IDACI score")


```

```{r child="GENDER_2018_commentary/Gender_Gender_ethnicity_socioeconomic_2.Rmd", results="asis"}
```

```{r out_table_G_PP_Eth_CS_ICT, results="asis", cache = FALSE}
print(out_table_G_PP_Eth_CS_ICT , add.to.row = addtorow_comp, include.colnames = FALSE) 
```

```{r child="GENDER_2018_commentary/Gender_Gender_ethnicity_socioeconomic_1.Rmd", results="asis"}
```

```{r out_table_IDACI, results="asis", cache = FALSE}
options(xtable.include.rownames=TRUE)
out_female_CS_IDACI
out_male_CS_IDACI
options(xtable.include.rownames=FALSE)
```

\pagebreak

```{r child="GENDER_2018_commentary/Gender_Gender_ethnicity_socioeconomic_3.Rmd", results="asis"}
```

```{r out_graph_IDACI, fig.height=3.8, fig.width=5.5, cache = FALSE, fig.cap="GCSE computer science and ICT, influence of IDACI on uptake by gender"}
graph_decile_idaci
```

```{r logistic_regression_computing_ethmaj_idaci, results="asis", cache = TRUE}
options(xtable.include.rownames=TRUE)
#out_female_CS_IDACI_EthMaj
#out_male_CS_IDACI_EthMaj
options(xtable.include.rownames=FALSE)
```

\pagebreak

```{r child="GENDER_2018_commentary/Gender_Gender_ethnicity_socioeconomic_4.Rmd", results="asis", cache=FALSE}
```

```{r out_graph_IDACI_Eth, fig.height=6, fig.width=5.7, cache = FALSE, fig.cap="GCSE computer science and ICT uptake, gender, ethnicity and IDACI quartile."}
graph_eth_idaci 
```
 
```{r table_female_cs_provision, message=TRUE,  warning=FALSE}
out_female_provision_by_sub <- function(df, sub, year){
  sub <- sym(sub)
  output<- df %>%
    group_by(schGender) %>%
    filter(GENDER == "F") %>%
    mutate(total_schools = length(unique(URN)),
           total_students = n()) %>%
    filter(!is.na(!!sub)) %>%
    mutate(sub_schools = length(unique(URN)),
           sub_students = n(),
           sub_per_schools = 100*(sub_schools / total_schools),
           sub_per_students = 100*(sub_students / total_students)) %>%
    distinct(schGender, total_schools, total_students, sub_schools, sub_students, sub_per_schools, sub_per_students)
  output$year <- year
 
  return(output)
}
 
cs_females <- out_female_provision_by_sub(Spread_GCSE_All, "X2610", 2016) %>%
  select(schGender, total_schools, total_students, sub_schools, sub_per_schools, sub_students, sub_per_students) %>% filter(!is.na(schGender), schGender != "Boys", schGender != "Not applicable") %>%
  ungroup()
names(cs_females) <- c("School type", "Total schools", "Total females", "CS schools", "CS schools %", "CS females", "CS females %")
 
ict_females <- out_female_provision_by_sub(Spread_GCSE_All, "X2650", 2016)  %>%
  select(schGender, total_schools, total_students, sub_schools, sub_per_schools, sub_students, sub_per_students) %>% filter(!is.na(schGender), schGender != "Boys", schGender != "Not applicable")  %>%
  ungroup()
names(ict_females) <- c("School type", "Total schools", "Total females", "ICT schools", "ICT schools %", "ICT females", "ICT females %")
 
cs_females <- cbind(cs_females, ict_females %>% select(`ICT schools`, `ICT schools %`, `ICT females`, `ICT females %`))
# females15 <- out_female_provision_by_sub(Spread_GCSE_15, "X2610", 2015)
# females14 <- out_female_provision_by_sub(Spread_GCSE_14, "X2610", 2014)
# females13 <- out_female_provision_by_sub(Spread_GCSE_13, "X2610", 2013)
# cs_females <- rbind(females16, rbind(females15, rbind(females14, females13)))
 
 
out_female_school_takeup <- xtable(cs_females,
                 caption="Percentage of females taking GCSE computer science and ICT by school gender characteristic.",
                 align = c('l', 'R{0.4in}|',
                                'R{0.4in}','R{0.5in}|',
                                'R{0.4in}','R{0.3in}',
                                'R{0.4in}','R{0.3in}|',
                                'R{0.4in}','R{0.3in}',
                                'R{0.4in}','R{0.3in}'),
                digits= c(0,0,0,0,0,1,0,1,0,1,0,1))

```
 
### School gender characteristic
Girls in single sex schools more likely to sit a GCSE in computer science than those in a mixed school (6.8% vs 3.9%), however, a smaller percentage of all girl providers offer computer science compared to mixed providers (38.6% vs 40.4%).

```{r output_table_female_cs_provision, results="asis", cache = FALSE}
# \blandscape
print(out_female_school_takeup, rotate.colnames = TRUE) # scalebox=0.90,
#\elandscape
```

```{r child="GENDER_2018_commentary/Gender_Achievement.Rmd", results="asis"}
```
 
```{r child="GENDER_2018_commentary/Gender_Relative_achievement_0.Rmd", results="asis"}
```

```{r Gender_significance, cache=FALSE}

########
# gives me stats for Sub ~ Gender
table <- subject_gender_regression %>% filter(model == " ~ GENDER + Avg_grades",
                                              n > 40000,
                                              output == "GENDERM")

table_Gender <- table[c("subject name", "n")]


###########
# gives me stats for Sub ~ Gender + Avg_Grades
table <- subject_gender_regression %>% ungroup() %>%
  filter(model == " ~ GENDER + Avg_grades", n > 40000) %>%
  mutate(p_value = p)  %>%
  mutate(Estimate = convertStar(p_value, num=est,digits=2)) %>%
  filter(output %in% c("GENDERM", "Avg_grades")) %>% 
  select(`subject name`,F_Mean, M_Mean, F_SD, M_SD, output, subject, n, Estimate, r2)

table <- table  %>% spread(output, Estimate) %>% 
  rename(G_Estimate = GENDERM,
         AG_Estimate = Avg_grades) %>% 
  arrange(desc(as.numeric(substr(G_Estimate,1,nchar(G_Estimate)-3))))


table_avg_GCSE <- table[c("subject name", "n", "G_Estimate", "AG_Estimate", "F_Mean", "M_Mean", "F_SD", "M_SD", "r2")]
table_avg_GCSE <- table_avg_GCSE %>% mutate(`F_avg_grade` = paste0(printper(F_Mean,2),
                                                "(",printper(F_SD,2),")"),
                          `M_avg_grade` = paste0(printper(M_Mean,2),
                                                "(",printper(M_SD,2),")"))
 
table <- left_join(table_avg_GCSE, table_Gender)
table <- table[c("subject name", "n", "F_avg_grade", "M_avg_grade", "AG_Estimate", "G_Estimate", "r2")]
 
addtorow <- list()
addtorow$pos <- list(0,0)
addtorow$command <- c("& & \\multicolumn{2}{c}{Avg Grade (SD)} & \\multicolumn{3}{c}{Estimate of subject result predictors} \\\\\n",
                      "Subject name & n & F & M & Avg.Grade & Gender & $R^2$ \\\\\n")
 
table <- xtable(table,
                         caption="GCSE grade outcome predicted by average GCSE grade and gender",
                         align =  c('l', 'p{1.15in}','R{0.5in}|',
                                    'R{0.6in}','R{0.6in}|',
                                    'R{0.7in}','R{0.5in}','R{0.4in}'),
                  #autosizeColumns(table, firstfields= c(1.2), page_width=7),
                         digits= c(0,0,0,0,0,2,2,2))
 
```
```{r out_Gender_regression, results="asis", cache = FALSE}
print(table, add.to.row = addtorow, include.colnames = FALSE)
```

```{r calc_difference_comp_to_other}
# work out the difference in grades between computing and other subjects
compare_gender_performance_subs_t_test <- function(data, sub1, sub2){
  # data <- Spread_GCSE_All
  # sub1 <- "X2610"
  # sub2 <- "X2650"
  
  # sub2 <- "X5030" = English Language
  # sub2 <- "X5110" = English Literature
  
  # sub2 <- "X2210"
  
  if(sub1 == sub2){
    # return 0s as comparing subject to itself
    genders <- data %>% filter(!is.na(!!sym(sub1))) %>% group_by(GENDER) %>% summarise(n = n())
    female <- genders %>% filter(GENDER == "F") %$% n
    male <- genders %>% filter(GENDER == "M") %$% n
    total_n <- sum(genders$n)
    
    # 21 returned values
    return(c(sub1,
             total_n,0.00,0.00,
             male,   0.00,0.00,
             female, 0.00,0.00,
             0,0,0,0,0,0,
             0,NA,NA,NA,NA,NA,NA,NA,NA,0,0,0,0))
  }else{
    temp <- data %>% 
      filter(!is.na(!!sym(sub1)), !is.na(!!sym(sub2))) %>%
      select(GENDER, !!sym(sub1), !!sym(sub2)) %>% 
      mutate(diff = as.double((!!sym(sub1)) - (!!sym(sub2))))
    
    #lm(diff ~ GENDER, data = temp)
    #lm(X2610 ~ GENDER + X2650, data = temp)
    
    Both.t.test <- ttest_d(temp %>% filter(GENDER=="F") %$% diff,
                           temp %>% filter(GENDER=="M") %$% diff)
    # summary(Both.t.test)
    # Both.t.test$d
    
    Both.lm <- summary(lm(paste(sub2, " ~ GENDER + ", sub1), data = temp))
    
    # compare the values of both models
    model1 <- lm(paste(sub2, " ~ GENDER + ", sub1), data = temp)
    model2 <- lm(paste(sub2, " ~ ", sub1), data = temp)
    ann <- anova(model1, model2, test="Chisq")
    
    # temp %>% group_by(GENDER) %>% summarise(over = sum(diff > 0),
    #                                        under = sum(diff < 0),
    #                                        equal = sum(diff == 0))

    temp <- temp %>% 
      mutate(total_n = n(),
             total_sd=sd(diff, na.rm=TRUE),
             total_diff = mean(diff)) %>%
      group_by(GENDER) %>% 
        summarise(
          total_n = max(total_n),
          total_sd = max(total_sd),
          total_diff = max(total_diff),
          n = n(),
          sd=sd(diff, na.rm=TRUE),
          over = sum(diff > 0), 
          under = sum(diff < 0),
          equal = sum(diff == 0),
          diff = mean(diff)) %>%  #TODO: get this data saved
      ungroup() %>%
      mutate(GENDER = as.character(GENDER))

    temp <- rbind(temp, c("TOTAL", 0,0,0, 
                  unique(temp$total_n), 
                  unique(temp$total_sd), 
                  unique(temp$total_diff)), 
                  0,0,0) %>%
      mutate(n = as.numeric(n),
             diff = as.numeric(diff),
             sd = as.numeric(sd))

    df <- c(sub2,
            temp %>% filter(GENDER=="TOTAL") %$% n,
            printper(temp %>% filter(GENDER=="TOTAL") %$% diff,2),
            printper(temp %>% filter(GENDER=="TOTAL") %$% sd,2),
            temp %>% filter(GENDER=="M") %$% n,
            printper(temp %>% filter(GENDER=="M") %$% diff,2),
            printper(temp %>% filter(GENDER=="M") %$% sd,2),
            temp %>% filter(GENDER=="F") %$% n,
            printper(temp %>% filter(GENDER=="F") %$% diff,2),
            printper(temp %>% filter(GENDER=="F") %$% sd,2),
            printper(temp %>% filter(GENDER=="M") %$% diff - 
                       temp %>% filter(GENDER=="F") %$% diff,2),
            temp %>% filter(GENDER=="M") %$% over,
            temp %>% filter(GENDER=="M") %$% equal,
            temp %>% filter(GENDER=="M") %$% under,
            temp %>% filter(GENDER=="F") %$% over,
            temp %>% filter(GENDER=="F") %$% equal,
            temp %>% filter(GENDER=="F") %$% under,
            printper(Both.t.test$p.value,3),
            printper(Both.t.test$parameter,0),
            printper(Both.t.test$statistic,3),
            Both.t.test$desc,
            convertStar(num=Both.lm$coefficients["(Intercept)", "Estimate"], 
                        p=Both.lm$coefficients["(Intercept)", "Pr(>|t|)"],
                        digits=2),
            convertStar(num=printper(Both.lm$coefficients[sub1, "Estimate"],2), 
                        p=Both.lm$coefficients[sub1, "Pr(>|t|)"],
                        digits=2),
            convertStar(num=printper(Both.lm$coefficients["GENDERM", "Estimate"],2), 
                        p=Both.lm$coefficients["GENDERM", "Pr(>|t|)"],
                        digits=2),
            printper(Both.lm$r.squared,2),
            ann$`Sum of Sq`[2],
            # ann$`F`[2],
            ann$`Pr(>Chi)`[2],
            ann$Res.Df[2],
            ann$Df[2])
    return(df)
    
  }
}

subjects <- subject_gender_regression %>% select(subject, `subject name`, n) %>%
  group_by(subject, `subject name`) %>%
  filter(n == max(n)) %>%
  ungroup() %>%
  distinct() %>%
  filter(n > 30000)

#### ICT to CS comparison
df <- c()
# sub <- "X2650"

#for(compr in subjects$subject){
compr  <- "X2610"
  for(sub in subjects$subject){
    temp <- compare_gender_performance_subs_t_test(Spread_GCSE_All, compr, sub)
    temp <- c(subjects[subjects$subject == sub,]$`subject name`, temp)
    message(paste(compr, sub))
    # print(df)
    
    df <- rbind(df, c(compr, temp))
  }
#}


temp_df <- df
df <- temp_df

df <- as.data.frame(df)
names(df) <- c("Base","Subject name","Subject",
               "Tn","TM", "TSD",
               "Mn","MM", "MSD", 
               "Fn", "FM", "FSD", 
               "diff",
               "Mover","Mequal","Munder",
               "Fover","Fequal","Funder",
               "t_p","t_df", "t_t", "t_desc", 
               "lm_int", "lm_CS", "lm_Gender", "LM_R2", 
               "an_sumsq", "an_p", "an_reddf", "an_df")

df$TM <- paste0(df$TM, "(", df$TSD,")")
df$MM <- paste0(df$MM, "(", df$MSD,")")
df$FM <- paste0(df$FM, "(", df$FSD,")")
df <- df %>% select(-Subject) %>% arrange(desc(FM)) %>%
  arrange(desc(as.numeric(substr(FM,1,nchar(FM)-6))))

# Enable this to also output results for All students as well as Males and Females.
# out_diff_table <- df[c("Base","Subject name","Tn","TM","Mn","MM", "Fn", "FM", "diff","lm_CS", "lm_Gender", "LM_R2")]
out_diff_table <- df[c("Subject name","Mn","MM", "Fn", "FM", "diff","lm_CS", "lm_Gender", "LM_R2")]


addtorow_comp <- list()
addtorow_comp$pos <- list(0,0)
addtorow_comp$command <- c("& \\multicolumn{2}{c}{Male} & \\multicolumn{2}{c}{Female} & & \\multicolumn{3}{c}{predictors of subject grade} \\\\\n",
                      "Subject name & n & M(SD) & n & M(SD) & Diff & CS grade & Gender & $R^2$ \\\\\n")
 
out_diff_table <- xtable(out_diff_table,
             caption="Average difference between GCSE computer science results and other subjects, by gender. Positive mean values signify students doing better in CS. Positive gender predictor values indicate males doing better",
             align =  c('l', 'p{1.1in}|',
                        'R{0.33in}','R{0.61in}|',
                        'R{0.33in}','R{0.61in}|',
                        'R{0.33in}|','R{0.52in}', 'R{0.51in}', 'R{0.28in}'),
             digits= c(0,0,0,0,0,0,2,0,0,3))
 
# how many students do both subjects?
temp <- Spread_GCSE_All %>% filter(!is.na(X2610), !is.na(X2650)) %>%
      select(GENDER, X2610, X2650) %>%
  group_by(GENDER) %>%
  mutate(diff = as.double(X2650 - X2610))
 
Both.t.test <- ttest_d(temp %>% filter(GENDER=="M") %$% diff,
                       temp %>% filter(GENDER=="F") %$% diff)
 
temp <- temp %>%
  summarise(avg_diff = mean(diff),
            sd = sd(diff),
            n=n())

both_girls <- temp %>% filter(GENDER == "F") %$% n
both_boys <- temp %>% filter(GENDER == "M") %$% n

an_ICT <- df %>% 
  filter(`Subject name` == "ICT") %>% 
  select(an_sumsq, an_p, an_reddf, an_df, t_desc)
an_EngLit <-  df %>% 
  filter(`Subject name` == "English Lit") %>% 
  select(an_sumsq, an_p, an_reddf, an_df, t_desc)
an_EngLan <- df %>% 
  filter(`Subject name` == "English Lang") %>% 
  select(an_sumsq, an_p, an_reddf, an_df, t_desc)
 
```

```{r child="GENDER_2018_commentary/Gender_Relative_achievement_1.Rmd", results="asis"}
``` 

\blandscape

```{r out_Gender_comp_comparison, results="asis", cache = FALSE}
print(out_diff_table, add.to.row = addtorow_comp, include.colnames = FALSE)
```

\elandscape

```{r significance_of_school_gender}
subjects <- names(Spread_GCSE_All %>% select(grep("X", names(.))))
focus <- c("PupilMatchingRefAnonymous", "GENDER", "schGender", subjects)
temp <- Spread_GCSE_All %>% select(focus)
# temp <- temp %>% gather(subject, grade, -PupilMatchingRefAnonymous, -GENDER, -schGender) %>% filter(!is.na(grade))
 
#get the avg_grade and grade differential for each gender and school_gender
results <- map(subjects, ~{
  # for some reason we have to assign this rather than use . directly
  x <- .
  message(.)
  temp <- Spread_GCSE_All %>% select(focus)
  results_with_avg <- temp[,names(temp) != x]
  Avg_grades <- results_with_avg %>%
                      select(grep("X", names(results_with_avg))) %>%
                      rowMeans(na.rm=TRUE)
 
  temp$Avg_grades <- Avg_grades
  temp<- temp %>%
    filter(!is.nan(Avg_grades)) %>%
    select(GENDER, schGender, Avg_grades, !!sym(x)) %>%
    mutate(focus_grade = !!sym(x),
           diff = focus_grade - Avg_grades) %>%
    select(-!!sym(x)) %>%
    filter(!is.na(focus_grade)) %>%
    group_by(schGender, GENDER) %>%
    summarise(n = n(),
              Avg_other = mean(Avg_grades),
              sd_other = sd(Avg_grades),
              Avg_focus = mean(focus_grade),
              sd_focus = sd(focus_grade),
              Avg_diff = mean(diff),
              sd_diff = sd(diff),
              subject = x)
 
  temp
})
 
# clean the table so we have focus and diff results next to each other
results <- rbind.fill(results) %>% filter(!is.na(schGender))
 
table <- results %>%
  group_by(subject) %>%
  mutate(total = sum(n)) %>%
  filter(total > 30000) %>%
  arrange(subject, schGender, GENDER) %>%
  group_by(subject, GENDER, schGender) %>%
  mutate(category = paste0(schGender, "_", GENDER)) %>%
  ungroup() %>%
  filter(category %in% c("Boys_M", "Girls_F", "Mixed_F", "Mixed_M")) %>%
  select(subject, category, Avg_diff, sd_diff, Avg_focus, sd_focus) %>%
  mutate(Avg_diff = printper(Avg_diff,2),
         sd_diff = printper(sd_diff,2),
         Avg_focus = printper(Avg_focus,2),
         sd_focus = printper(sd_focus,2),
         diff = paste0(Avg_diff, "(",sd_diff,")"),
         focus = paste0(Avg_focus, "(",sd_focus,")"))
 
table_focus <- table %>% select(subject, category, focus) %>% mutate(category = paste0("focus_",category)) %>% spread(category, focus)
table_diff <- table %>% select(subject, category, diff) %>% mutate(category = paste0("diff_",category)) %>% spread(category, diff)
 
# join table and reorder columns
table_gender_school <- left_join(table_focus, table_diff) %>% select(subject,
                                                                     focus_Boys_M, focus_Mixed_M, focus_Mixed_F, focus_Girls_F,
                                                                     diff_Boys_M, diff_Mixed_M, diff_Mixed_F, diff_Girls_F)
# add the subject name
table_gender_school <- left_join(table_gender_school,
                                 Disccodes,
                                 by=c("subject"="MAPPING")) %>%
                        rename(code = subject,
                        subject = MAPPING_DESCRIPTION)%>%
                        select(subject,
                               focus_Boys_M, focus_Mixed_M, focus_Mixed_F, focus_Girls_F,
                               diff_Boys_M, diff_Mixed_M, diff_Mixed_F, diff_Girls_F)

# \pagebreak

```

 
```{r child="GENDER_2018_commentary/Gender_School_Gender_achievement_0.Rmd", results="asis"}
``` 

\blandscape

```{r print_significance_of_school_gender, results="asis", cache = FALSE}
 
# ready table for printing
addtorow_comp <- list()
addtorow_comp$pos <- list(0,0,0)
addtorow_comp$command <- c("& \\multicolumn{4}{c}{Avg grade in subject(SD)} | & \\multicolumn{4}{c}{Difference from avg grade(SD)} \\\\\n",
                      "Sch Gender & \\multicolumn{1}{c}{Boys} | & \\multicolumn{2}{c}{Mixed} | & \\multicolumn{1}{c}{Girls} | & \\multicolumn{1}{c}{Boys} | & \\multicolumn{2}{c}{Mixed} | & \\multicolumn{1}{c}{Girls} \\\\\n",
                      "Subject & \\multicolumn{2}{c}{Male} | & \\multicolumn{2}{c}{Female} | & \\multicolumn{2}{c}{Male} | &  \\multicolumn{2}{c}{Female} \\\\\n")
 
out_table_gender_school <- xtable(table_gender_school,
             caption="Subject performance by school gender charactistic and pupil gender. Negative difference values signify students doing worse in given subject",
             align =  c('l', 'p{1.1in}|',
                        rep('R{0.55in}',3),'R{0.55in}|',
                        rep('R{0.65in}',4)),
             digits= c(0,0,0,0,0,0,0,0,0,0))
 
print(out_table_gender_school , add.to.row = addtorow_comp, include.colnames = FALSE)
```

\elandscape

```{r child="GENDER_2018_commentary/Gender_School_Gender_achievement_1.Rmd", results="asis"}
``` 

```{r print_school_type_gender_size, results="asis", cache = FALSE}
print(out_school_type_gender_size, add.to.row = addtorow_gen_size, include.colnames = FALSE) 
# out_school_type_gender_size

# options(xtable.include.rownames=TRUE)
# out_modl_Mixed_n_male
# out_modl_Mixed_n_female 
# out_modl_Mixed_per_male
# out_modl_Mixed_per_female
# out_modl_Single_n_male
# out_modl_Single_n_female 
# options(xtable.include.rownames=FALSE)

# print(out_school_type_gender_size, include.colnames = FALSE, type='html', options(xtable.sanitize.text.function = identity)) 
```

\pagebreak

```{r child="GENDER_2018_commentary/Gender_School_Gender_achievement_2.Rmd", results="asis"}
``` 

```{r Group_size_significance_n_f, fig.height=3, cache=FALSE, fig.cap="GCSE computer science cohort size (n) and relative performance by gender and school type"}
graph_gender_n_perf 
```
 
```{r Group_size_significance_n_m, fig.height=3, cache=FALSE, fig.cap="GCSE computer science cohort size (%) and relative performance by gender and school type"}
graph_gender_per_perf 
```

```{r Results_Exam_Board}
x <- "X2610"
# message(x)

temp <- left_join(Results_GCSE_All %>% filter(SUBLEVNO == "310", MAPPING == "2610") %>% select(-URN),
                  Students_GCSE_All %>% select(PupilMatchingRefAnonymous, GENDER))

results_with_avg <- Spread_GCSE_All[,names(Spread_GCSE_All) != x]
people <- results_with_avg %>% select(PupilMatchingRefAnonymous)
Avg_grades <- results_with_avg %>%
  select(grep("X", names(.))) %>%
  rowMeans(na.rm=TRUE)
people$Avg_grades <- Avg_grades

temp <- left_join(temp, people)


Board_desc <- temp %>% group_by(QAN, GENDER) %>% 
                        filter(!is.na(Avg_grades)) %>% 
                        summarise(n=n(), 
                                   Avg_CS = mean(POINTS),
                                   Avg_All = mean(Avg_grades),
                                  SD_CS = sd(POINTS),
                                  SD_All = sd(POINTS))

Board_stat <- temp %>% 
  group_by(QAN) %>% 
  summarise(p_avg_cs = 
              ttest_d(
                  POINTS[GENDER == "M"],
                  POINTS[GENDER == "F"])$p.value,
            p_avg_desc = 
              ttest_d(
                  POINTS[GENDER == "M"],
                  POINTS[GENDER == "F"])$desc,
            p_diff_cs = 
              ttest_d(
                POINTS[GENDER == "M"] - Avg_grades[GENDER == "M"],
                POINTS[GENDER == "F"] - Avg_grades[GENDER == "F"])$p.value,
            p_diff_desc = 
              ttest_d(
                POINTS[GENDER == "M"] - Avg_grades[GENDER == "M"],
                POINTS[GENDER == "F"] - Avg_grades[GENDER == "F"])$desc)

Board_gender <- Board_desc %>% select(QAN, GENDER, n) %>% spread(GENDER, n)
Board_Avg_CS <- Board_desc %>% select(QAN, GENDER, Avg_CS) %>% spread(GENDER, Avg_CS)
Board_SD_CS <- Board_desc %>% select(QAN, GENDER, SD_CS) %>% spread(GENDER, SD_CS) 
Board_Avg_All <- Board_desc %>% select(QAN, GENDER, Avg_All) %>% spread(GENDER, Avg_All)
Board_SD_All <- Board_desc %>% select(QAN, GENDER, SD_All) %>% spread(GENDER, SD_All) 

names(Board_gender) <- c("QAN", "n_F", "n_M")
names(Board_Avg_CS) <- c("QAN", "Avg_CS_F", "Avg_CS_M")
names(Board_SD_CS) <- c("QAN", "SD_CS_F", "SD_CS_M")
names(Board_Avg_All) <- c("QAN", "Avg_All_F", "Avg_All_M")
names(Board_SD_All) <- c("QAN", "SD_All_F", "SD_All_M")

table <- left_join(Board_gender, left_join(Board_Avg_All, left_join(Board_SD_All, left_join(Board_Avg_CS, left_join(Board_SD_CS, Board_stat)))))

table$CS_gender_diff <- printper(table$Avg_CS_F - table$Avg_CS_M,2)
table$CS_F_diff <- printper(table$Avg_CS_F - table$Avg_All_F,2)
table$CS_M_diff <- printper(table$Avg_CS_M - table$Avg_All_M,2)
table$Avg_All_F <- paste0(printper(table$Avg_All_F,2), " (",printper(table$SD_All_F,2),")")
table$Avg_All_M <- paste0(printper(table$Avg_All_M,2), " (",printper(table$SD_All_M,2),")")
table$CS_All_F <- paste0(printper(table$Avg_CS_F,2), " (",printper(table$SD_CS_F,2),")")
table$CS_All_M <- paste0(printper(table$Avg_CS_M,2), " (",printper(table$SD_CS_M,2),")")

exam_boards <- table %>% select(QAN, n_F, n_M, Avg_All_F, Avg_All_M, CS_All_F, CS_All_M, CS_F_diff, CS_M_diff, p_diff_cs)

e50082917<- Board_stat %>% filter(QAN == "50082917") %$% p_diff_desc
e6004908X<- Board_stat %>% filter(QAN == "6004908X") %$% p_diff_desc
e60064420<- Board_stat %>% filter(QAN == "60064420") %$% p_diff_desc
e60105446<- Board_stat %>% filter(QAN == "60105446") %$% p_diff_desc
```

\pagebreak

```{r child="GENDER_2018_commentary/Gender_Exam_board.Rmd", results="asis"}
``` 

```{r table_exam_boards, cache=FALSE, results="asis"}
out_exam_boards <- xtable(exam_boards,
                             caption="GCSE CS results by exam board",
                             align = c('l', 'p{0.5in}|','R{0.29in}','R{0.36in}',
                                       'R{0.6in}','R{0.6in}','R{0.6in}','R{0.6in}',
                                       'R{0.32in}','R{0.32in}','R{0.4in}'),
                             digits= c(0,0,0,0,0,0,0,0,0,0,3))
addtorow <- list()
addtorow$pos <- list(0,0)
addtorow$command <- c("Exam & \\multicolumn{2}{c}{n} | & \\multicolumn{2}{c}{Overall average (SD)} | & \\multicolumn{2}{c}{CS average (SD)} | & \\multicolumn{2}{c}{CS - overall} &  t-test \\\\\n",
                      "board & F & M | & F & M | & F & M | & F & M & Pr(>|t|) \\\\\n")

# , results="asis"
#out_exam_boards
print(out_exam_boards , add.to.row = addtorow, include.colnames = FALSE) 
```
```{r child="GENDER_2018_commentary/Gender_Assumptions_and_limitations.Rmd", results="asis", cache=FALSE}
``` 

```{r child="GENDER_2018_commentary/Gender_Discussion.Rmd", results="asis", cache=FALSE}
``` 

```{r child="GENDER_2018_commentary/Gender_Conclusion.Rmd", results="asis", cache=FALSE}

``` 


```{r table_ICT_glm_models, cache=FALSE, results="asis"}
#Appendix
#options(xtable.include.rownames=TRUE)
# out_female_ICT_IDACI_EthMaj
# out_male_ICT_IDACI_EthMaj

#out_female_ICT_IDACI
#out_male_ICT_IDACI
#options(xtable.include.rownames=FALSE)
```

```{r out_Gender_regression_graph, cache = FALSE, fig.cap="Influence of gender on grade, controlling for ability in other subjects. Positive=males doing better", fig.height=4}
# graph_significance_Gender_AvgGrade
```

#Bibliography
